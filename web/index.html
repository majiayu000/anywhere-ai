<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anywhere AI Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .new-session {
            margin: 1rem;
            padding: 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .new-session:hover {
            background: #2563eb;
        }

        .sessions {
            flex: 1;
            overflow-y: auto;
            padding: 0 1rem;
        }

        .session {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background 0.2s;
        }

        .session:hover {
            background: #f9fafb;
        }

        .session.active {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .session-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .session-info {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Chat Area */
        .chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            min-height: 0;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .clear-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            color: #6b7280;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .clear-btn:hover {
            background: #e5e7eb;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: calc(100vh - 200px);
            min-height: 200px;
            scroll-behavior: smooth;
            /* Á°Æ‰øùÊªöÂä®Êù°ÂèØËßÅ */
            scrollbar-width: thin;
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: #10b981;
            color: white;
        }

        .message.agent .avatar {
            background: #3b82f6;
            color: white;
        }

        .content {
            flex: 1;
        }

        .sender {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .text {
            line-height: 1.5;
            color: #374151;
            word-wrap: break-word;
        }

        .text pre {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
        }

        .text code {
            background: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
        }

        /* Typing Animation */
        .typing-indicator {
            display: flex;
            gap: 0.75rem;
            padding: 0.5rem 0;
            animation: fadeIn 0.3s ease;
        }

        .typing-indicator .avatar {
            background: #3b82f6;
            color: white;
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: #f3f4f6;
            border-radius: 1rem;
            max-width: 150px;
        }

        .typing-dots::before {
            content: "ü§ñ Claude ÊÄùËÄÉ‰∏≠";
            font-size: 0.875rem;
            color: #6b7280;
        }

        .typing-dots::after {
            content: "...";
            animation: typing 1.5s infinite;
            font-weight: bold;
            color: #3b82f6;
        }

        @keyframes typing {
            0%, 20% { content: ""; }
            40% { content: "."; }
            60% { content: ".."; }
            80%, 100% { content: "..."; }
        }

        /* Input Area */
        .input-area {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.75rem;
            transition: border-color 0.2s;
        }

        .input-box:focus-within {
            border-color: #3b82f6;
            background: white;
        }

        .message-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            min-height: 20px;
            max-height: 100px;
        }

        .send-btn {
            padding: 0.75rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: #2563eb;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn.loading {
            background: #9ca3af;
            position: relative;
            overflow: hidden;
        }

        .send-btn.loading::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Empty State */
        .empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .empty h3 {
            margin-bottom: 0.5rem;
            color: #4b5563;
        }

        /* Loading */
        .loading {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
            padding: 2rem;
        }

        /* Command Autocomplete */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px 6px 0 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #eff6ff;
        }

        .autocomplete-command {
            font-weight: 600;
            color: #3b82f6;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .autocomplete-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ü§ñ Anywhere AI Chat</div>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">ËøûÊé•‰∏≠...</span>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <button class="new-session" onclick="createNewSession()">
                ‚ú® Êñ∞Âª∫‰ºöËØù
            </button>
            <div class="sessions" id="sessionsList">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat">
            <!-- Empty State -->
            <div class="empty" id="emptyState">
                <h3>üí¨ ËØ∑ÈÄâÊã©ÊàñÂàõÂª∫‰ºöËØù</h3>
                <p>‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™‰ºöËØùÊàñÂàõÂª∫Êñ∞‰ºöËØùÂºÄÂßãÂØπËØù</p>
            </div>

            <!-- Chat Interface -->
            <div id="chatInterface" style="display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden;">
                <div class="chat-header">
                    <span id="chatTitle">Claude ‰ºöËØù</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="clear-btn" onclick="forceScrollToBottom()">ÊªöÂä®Âà∞Â∫ïÈÉ®</button>
                        <button class="clear-btn" onclick="clearMessages()">Ê∏ÖÁ©∫Ê∂àÊÅØ</button>
                    </div>
                </div>

                <div class="messages" id="messagesContainer">
                    <!-- Messages will appear here -->
                </div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <div class="input-box autocomplete-container">
                            <!-- Autocomplete Dropdown -->
                            <div class="autocomplete-dropdown" id="autocompleteDropdown">
                                <!-- Autocomplete items will appear here -->
                            </div>
                            
                            <textarea 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="ËæìÂÖ•ÊÇ®ÁöÑÊ∂àÊÅØ... (ËæìÂÖ• / Êü•ÁúãÂëΩ‰ª§)"
                                onkeydown="handleKeyPress(event)"
                                oninput="autoResize(this); handleInput(event)"
                                oncompositionstart="handleCompositionStart(event)"
                                oncompositionend="handleCompositionEnd(event)"
                                oncompositionupdate="isComposing = true"
                            ></textarea>
                        </div>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                            ÂèëÈÄÅ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let ws = null;
        let currentSessionId = null;
        let sessions = [];
        let messages = [];
        let isTyping = false;
        let typingTimeout = null;
        let isComposing = false; // IME ËæìÂÖ•Áä∂ÊÄÅ
        let lastCompositionEnd = 0; // ÊúÄÂêé‰∏ÄÊ¨°compositionÁªìÊùüÊó∂Èó¥

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
            connectWebSocket();
            loadClaudeCommands(); // Âä†ËΩΩÊúÄÊñ∞ÁöÑClaudeÂëΩ‰ª§ÂàóË°®
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèËá™Âä®Ë°•ÂÖ®
            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('autocompleteDropdown');
                const inputArea = document.querySelector('.input-area');
                
                if (dropdown.classList.contains('show') && 
                    !inputArea.contains(event.target)) {
                    hideAutocomplete();
                }
            });
        });

        // WebSocket Connection
        function connectWebSocket() {
            ws = new WebSocket(`ws://localhost:8080/api/v1/ws`);
            
            ws.onopen = () => {
                console.log('WebSocketËøûÊé•ÊàêÂäü');
                updateStatus(true, 'Â∑≤ËøûÊé•');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocketËøûÊé•Êñ≠ÂºÄ');
                updateStatus(false, 'ËøûÊé•Êñ≠ÂºÄ');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocketÈîôËØØ:', error);
                updateStatus(false, 'ËøûÊé•ÈîôËØØ');
            };
        }

        // Update Connection Status
        function updateStatus(connected, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                statusText.textContent = text || 'Â∑≤ËøûÊé•';
            } else {
                dot.classList.remove('connected');
                statusText.textContent = text || 'Êú™ËøûÊé•';
            }
        }

        // Handle WebSocket Messages
        function handleWebSocketMessage(data) {
            switch(data.action) {
                case 'messages':
                    if (data.sessionId === currentSessionId) {
                        messages = data.data || [];
                        renderMessages();
                    }
                    break;
                    
                case 'newMessage':
                    if (data.sessionId === currentSessionId && data.data) {
                        const message = data.data;
                        
                        // Êî∂Âà∞AgentÊ∂àÊÅØÊó∂ÈöêËóèËæìÂÖ•Âä®Áîª
                        if (message.sender_type === 'AGENT') {
                            hideTypingIndicator();
                        }
                        
                        messages.push(message);
                        renderMessages();
                        scrollToBottom();
                    }
                    break;
                    
                case 'typing':
                    if (data.sessionId === currentSessionId) {
                        showTypingIndicator();
                    }
                    break;
                    
                case 'stopTyping':
                    if (data.sessionId === currentSessionId) {
                        hideTypingIndicator();
                    }
                    break;
            }
        }

        // Load Sessions
        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/terminal/sessions`);
                if (response.ok) {
                    sessions = await response.json();
                    renderSessions();
                }
            } catch (error) {
                console.error('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•:', error);
                document.getElementById('sessionsList').innerHTML = 
                    '<div style="color: #ef4444; text-align: center; padding: 1rem;">Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        // Render Sessions
        function renderSessions() {
            const container = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 1rem;">ÊöÇÊó†‰ºöËØù</div>';
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="session ${session.id === currentSessionId ? 'active' : ''}" 
                     onclick="selectSession('${session.id}')">
                    <div class="session-name">
                        ü§ñ ${session.name || session.id}
                    </div>
                    <div class="session-info">
                        ${session.tool} ‚Ä¢ ${session.status === 'active' ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢'}
                    </div>
                </div>
            `).join('');
        }

        // Select Session
        async function selectSession(sessionId) {
            // ÈáçÁΩÆËæìÂÖ•Áä∂ÊÄÅ
            hideTypingIndicator();
            
            currentSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            
            if (session) {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'flex';
                document.getElementById('chatTitle').textContent = `ü§ñ ${session.name || session.id}`;
                
                // Ê∏ÖÁ©∫Ê∂àÊÅØ
                messages = [];
                document.getElementById('messagesContainer').innerHTML = '';
                
                // ËÆ¢ÈòÖ‰ºöËØù
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ 
                        action: 'subscribe', 
                        sessionId: sessionId 
                    }));
                    
                    ws.send(JSON.stringify({
                        action: 'selectSession',
                        sessionId: sessionId
                    }));
                }
                
                renderSessions();
            }
        }

        // Render Messages
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            
            if (messages.length === 0 && !isTyping) {
                container.innerHTML = '<div class="loading">ÊöÇÊó†Ê∂àÊÅØÔºåÂºÄÂßãÂØπËØùÂêßÔºÅ</div>';
                return;
            }

            let html = messages.map(msg => {
                const isAgent = msg.sender_type === 'AGENT';
                const time = new Date(msg.created_at).toLocaleTimeString();
                
                return `
                    <div class="message ${isAgent ? 'agent' : 'user'}">
                        <div class="avatar">
                            ${isAgent ? 'ü§ñ' : 'üë§'}
                        </div>
                        <div class="content">
                            <div class="sender">
                                ${isAgent ? 'Claude' : 'Êàë'}
                                <span class="time">${time}</span>
                            </div>
                            <div class="text">${formatMessage(msg.content)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ê∑ªÂä†ËæìÂÖ•Âä®Áîª
            if (isTyping) {
                html += `
                    <div class="typing-indicator">
                        <div class="avatar">ü§ñ</div>
                        <div class="typing-dots"></div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            // Âª∂ËøüÊªöÂä®Á°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
            setTimeout(() => scrollToBottom(), 50);
        }

        // Format Message Content
        function formatMessage(content) {
            // HTMLËΩ¨‰πâ
            content = content.replace(/&/g, '&amp;')
                           .replace(/</g, '&lt;')
                           .replace(/>/g, '&gt;');
            
            // ‰ª£Á†ÅÂùó
            content = content.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
            
            // Ë°åÂÜÖ‰ª£Á†Å
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Êç¢Ë°å
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentSessionId || isComposing) return;

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.classList.add('loading');
            sendBtn.textContent = 'ÂèëÈÄÅ‰∏≠...';

            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        action: 'sendMessage',
                        sessionId: currentSessionId,
                        input: message
                    }));
                    
                    input.value = '';
                    autoResize(input);
                    
                    // ÊòæÁ§∫ËæìÂÖ•Âä®Áîª
                    showTypingIndicator();
                }
            } catch (error) {
                console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
                hideTypingIndicator();
            } finally {
                // ÈáçÁΩÆÂèëÈÄÅÊåâÈíÆ
                setTimeout(() => {
                    sendBtn.disabled = false;
                    sendBtn.classList.remove('loading');
                    sendBtn.textContent = 'ÂèëÈÄÅ';
                }, 1000);
            }
        }

        // Show/Hide Typing Indicator
        function showTypingIndicator() {
            if (!isTyping && currentSessionId) {
                isTyping = true;
                renderMessages();
                
                // 30ÁßíÂêéËá™Âä®ÈöêËóè
                typingTimeout = setTimeout(() => {
                    hideTypingIndicator();
                }, 30000);
            }
        }

        function hideTypingIndicator() {
            if (isTyping) {
                isTyping = false;
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                    typingTimeout = null;
                }
                renderMessages();
            }
        }

        // Handle Key Press & IME - ÈáçÊñ∞ËÆæËÆ°
        function handleKeyPress(event) {
            // È¶ñÂÖàÂ§ÑÁêÜËá™Âä®Ë°•ÂÖ®ÂØºËà™
            if (handleAutocompleteNavigation(event)) {
                return; // Â¶ÇÊûúÂ§ÑÁêÜ‰∫ÜËá™Âä®Ë°•ÂÖ®ÂØºËà™ÔºåÁõ¥Êé•ËøîÂõû
            }

            // ÂÖ≥ÈîÆÔºöÂè™ÊúâÂú®Á°ÆËÆ§‰∏çÊòØËæìÂÖ•Ê≥ïÁä∂ÊÄÅÊó∂ÊâçÂ§ÑÁêÜEnter
            if (event.key === 'Enter' && !event.shiftKey) {
                // Â¶ÇÊûúÊ≠£Âú®ËæìÂÖ•Ê≥ïÁªÑÂêà‰∏≠ÔºåÂÆåÂÖ®‰∏çÂ§ÑÁêÜÔºåËÆ©ËæìÂÖ•Ê≥ïËá™Â∑±Â§ÑÁêÜ
                if (isComposing) {
                    console.log('Âú®ËæìÂÖ•Ê≥ïÁªÑÂêà‰∏≠ÔºåËÆ©ËæìÂÖ•Ê≥ïÂ§ÑÁêÜEnterÈîÆ');
                    return; // ‰∏çË∞ÉÁî® preventDefaultÔºåËÆ©ËæìÂÖ•Ê≥ïÈÄâËØç
                }
                
                // ÂàöÁªìÊùüËæìÂÖ•Ê≥ïÈÄâËØçÂêéÁöÑÁü≠ÊöÇÊó∂Èó¥ÂÜÖ‰πü‰∏çÂ§ÑÁêÜ
                const now = Date.now();
                if (now - lastCompositionEnd < 150) {
                    console.log('ÂàöÁªìÊùüËæìÂÖ•Ê≥ïÔºåÁ≠âÂæÖ‰∏Ä‰∏ã');
                    return;
                }
                
                // Âè™ÊúâÂú®ÈùûËæìÂÖ•Ê≥ïÁä∂ÊÄÅ‰∏ãÊâçÂèëÈÄÅÊ∂àÊÅØ
                console.log('ÂèëÈÄÅÊ∂àÊÅØ');
                event.preventDefault();
                sendMessage();
            }
        }

        function handleCompositionStart(event) {
            console.log('üéå ËæìÂÖ•Ê≥ïÂºÄÂßã:', event.data);
            isComposing = true;
        }

        function handleCompositionEnd(event) {
            console.log('üéå ËæìÂÖ•Ê≥ïÁªìÊùü:', event.data);
            isComposing = false;
            lastCompositionEnd = Date.now();
        }

        // Command autocomplete data - ‰ªéÂÆòÊñπÊñáÊ°£Âä®ÊÄÅËé∑Âèñ
        let claudeCommands = [
            // ÈªòËÆ§ÂëΩ‰ª§ÔºåÂΩìÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•Êó∂‰ΩøÁî®
            { command: '/help', description: 'Ëé∑Âèñ‰ΩøÁî®Â∏ÆÂä©' },
            { command: '/clear', description: 'Ê∏ÖÁ©∫ÂØπËØùÂéÜÂè≤' },
            { command: '/status', description: 'Êü•ÁúãË¥¶Êà∑ÂíåÁ≥ªÁªüÁä∂ÊÄÅ' },
            { command: '/model', description: 'ÈÄâÊã©ÊàñÊõ¥ÊîπAIÊ®°Âûã' }
        ];

        // ‰ªéÂÆòÊñπÊñáÊ°£Ëé∑ÂèñÊúÄÊñ∞ÂëΩ‰ª§ÂàóË°®
        async function loadClaudeCommands() {
            try {
                // Â∞ùËØïÈÄöËøáÂêéÁ´Ø‰ª£ÁêÜËé∑ÂèñÂëΩ‰ª§ÂàóË°®
                const response = await fetch(`${API_BASE}/api/v1/claude-commands`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.commands && data.commands.length > 0) {
                        claudeCommands = data.commands.map(cmd => ({
                            command: cmd.command,
                            description: translateDescription(cmd.description)
                        }));
                        console.log(`‚úÖ ÈÄöËøáÂêéÁ´Ø‰ª£ÁêÜÊàêÂäüÂä†ËΩΩ ${claudeCommands.length} ‰∏™ClaudeÂëΩ‰ª§`);
                        return;
                    }
                }
                
                // Â¶ÇÊûúÂêéÁ´Ø‰ª£ÁêÜÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÂÆåÊï¥ÂàóË°®
                claudeCommands = [
                    { command: '/add-dir', description: 'Ê∑ªÂä†È¢ùÂ§ñÁöÑÂ∑•‰ΩúÁõÆÂΩï' },
                    { command: '/agents', description: 'ÁÆ°ÁêÜ‰∏ìÁî®‰ªªÂä°ÁöÑËá™ÂÆö‰πâAIÂ≠ê‰ª£ÁêÜ' },
                    { command: '/bug', description: 'Êä•ÂëäÈîôËØØÔºàÂèëÈÄÅÂØπËØùÂà∞AnthropicÔºâ' },
                    { command: '/clear', description: 'Ê∏ÖÁ©∫ÂØπËØùÂéÜÂè≤' },
                    { command: '/compact', description: 'ÂéãÁº©ÂØπËØùÔºåÂèØÈÄâËÅöÁÑ¶Êåá‰ª§' },
                    { command: '/config', description: 'Êü•Áúã/‰øÆÊîπÈÖçÁΩÆ' },
                    { command: '/cost', description: 'ÊòæÁ§∫token‰ΩøÁî®ÁªüËÆ°' },
                    { command: '/doctor', description: 'Ê£ÄÊü•Claude CodeÂÆâË£ÖÂÅ•Â∫∑Áä∂ÊÄÅ' },
                    { command: '/help', description: 'Ëé∑Âèñ‰ΩøÁî®Â∏ÆÂä©' },
                    { command: '/init', description: '‰ΩøÁî®CLAUDE.mdÊåáÂçóÂàùÂßãÂåñÈ°πÁõÆ' },
                    { command: '/login', description: 'ÂàáÊç¢AnthropicË¥¶Êà∑' },
                    { command: '/logout', description: 'ÈÄÄÂá∫AnthropicË¥¶Êà∑' },
                    { command: '/mcp', description: 'ÁÆ°ÁêÜMCPÊúçÂä°Âô®ËøûÊé•ÂíåOAuthËÆ§ËØÅ' },
                    { command: '/memory', description: 'ÁºñËæëCLAUDE.mdËÆ∞ÂøÜÊñá‰ª∂' },
                    { command: '/model', description: 'ÈÄâÊã©ÊàñÊõ¥ÊîπAIÊ®°Âûã' },
                    { command: '/permissions', description: 'Êü•ÁúãÊàñÊõ¥Êñ∞ÊùÉÈôê' },
                    { command: '/pr_comments', description: 'Êü•ÁúãÊãâÂèñËØ∑Ê±ÇËØÑËÆ∫' },
                    { command: '/review', description: 'ËØ∑Ê±Ç‰ª£Á†ÅÂÆ°Êü•' },
                    { command: '/status', description: 'Êü•ÁúãË¥¶Êà∑ÂíåÁ≥ªÁªüÁä∂ÊÄÅ' },
                    { command: '/terminal-setup', description: 'ÂÆâË£ÖShift+EnterÊç¢Ë°åÈîÆÁªëÂÆö' },
                    { command: '/vim', description: 'ËøõÂÖ•vimÊ®°ÂºèÔºå‰∫§ÊõøÊèíÂÖ•ÂíåÂëΩ‰ª§Ê®°Âºè' }
                ];
                console.log('üìã ‰ΩøÁî®ÂÜÖÁΩÆÂÆåÊï¥ÂëΩ‰ª§ÂàóË°®');
                
            } catch (error) {
                console.error('‚ùå Ëé∑ÂèñClaudeÂëΩ‰ª§Â§±Ë¥•:', error);
                // ÁΩëÁªúÈîôËØØÊó∂‰ΩøÁî®Â§áÁî®ÂëΩ‰ª§ÂàóË°®
                claudeCommands = [
                    { command: '/add-dir', description: 'Ê∑ªÂä†È¢ùÂ§ñÁöÑÂ∑•‰ΩúÁõÆÂΩï' },
                    { command: '/agents', description: 'ÁÆ°ÁêÜ‰∏ìÁî®‰ªªÂä°ÁöÑËá™ÂÆö‰πâAIÂ≠ê‰ª£ÁêÜ' },
                    { command: '/bug', description: 'Êä•ÂëäÈîôËØØÔºàÂèëÈÄÅÂØπËØùÂà∞AnthropicÔºâ' },
                    { command: '/clear', description: 'Ê∏ÖÁ©∫ÂØπËØùÂéÜÂè≤' },
                    { command: '/compact', description: 'ÂéãÁº©ÂØπËØùÔºåÂèØÈÄâËÅöÁÑ¶Êåá‰ª§' },
                    { command: '/config', description: 'Êü•Áúã/‰øÆÊîπÈÖçÁΩÆ' },
                    { command: '/cost', description: 'ÊòæÁ§∫token‰ΩøÁî®ÁªüËÆ°' },
                    { command: '/doctor', description: 'Ê£ÄÊü•Claude CodeÂÆâË£ÖÂÅ•Â∫∑Áä∂ÊÄÅ' },
                    { command: '/help', description: 'Ëé∑Âèñ‰ΩøÁî®Â∏ÆÂä©' },
                    { command: '/init', description: '‰ΩøÁî®CLAUDE.mdÊåáÂçóÂàùÂßãÂåñÈ°πÁõÆ' },
                    { command: '/login', description: 'ÂàáÊç¢AnthropicË¥¶Êà∑' },
                    { command: '/logout', description: 'ÈÄÄÂá∫AnthropicË¥¶Êà∑' },
                    { command: '/mcp', description: 'ÁÆ°ÁêÜMCPÊúçÂä°Âô®ËøûÊé•ÂíåOAuthËÆ§ËØÅ' },
                    { command: '/memory', description: 'ÁºñËæëCLAUDE.mdËÆ∞ÂøÜÊñá‰ª∂' },
                    { command: '/model', description: 'ÈÄâÊã©ÊàñÊõ¥ÊîπAIÊ®°Âûã' },
                    { command: '/permissions', description: 'Êü•ÁúãÊàñÊõ¥Êñ∞ÊùÉÈôê' },
                    { command: '/pr_comments', description: 'Êü•ÁúãÊãâÂèñËØ∑Ê±ÇËØÑËÆ∫' },
                    { command: '/review', description: 'ËØ∑Ê±Ç‰ª£Á†ÅÂÆ°Êü•' },
                    { command: '/status', description: 'Êü•ÁúãË¥¶Êà∑ÂíåÁ≥ªÁªüÁä∂ÊÄÅ' },
                    { command: '/terminal-setup', description: 'ÂÆâË£ÖShift+EnterÊç¢Ë°åÈîÆÁªëÂÆö' },
                    { command: '/vim', description: 'ËøõÂÖ•vimÊ®°ÂºèÔºå‰∫§ÊõøÊèíÂÖ•ÂíåÂëΩ‰ª§Ê®°Âºè' }
                ];
                console.log('üîÑ ‰ΩøÁî®Â§áÁî®ÂëΩ‰ª§ÂàóË°®');
            }
        }

        // ÁøªËØëÂ∏∏ËßÅÂëΩ‰ª§ÊèèËø∞
        function translateDescription(desc) {
            const translations = {
                'Add additional working directories': 'Ê∑ªÂä†È¢ùÂ§ñÁöÑÂ∑•‰ΩúÁõÆÂΩï',
                'Manage custom AI subagents for specialized tasks': 'ÁÆ°ÁêÜ‰∏ìÁî®‰ªªÂä°ÁöÑËá™ÂÆö‰πâAIÂ≠ê‰ª£ÁêÜ',
                'Report bugs (sends conversation to Anthropic)': 'Êä•ÂëäÈîôËØØÔºàÂèëÈÄÅÂØπËØùÂà∞AnthropicÔºâ',
                'Clear conversation history': 'Ê∏ÖÁ©∫ÂØπËØùÂéÜÂè≤',
                'Compact conversation with optional focus instructions': 'ÂéãÁº©ÂØπËØùÔºåÂèØÈÄâËÅöÁÑ¶Êåá‰ª§',
                'View/modify configuration': 'Êü•Áúã/‰øÆÊîπÈÖçÁΩÆ',
                'Show token usage statistics': 'ÊòæÁ§∫token‰ΩøÁî®ÁªüËÆ°',
                'Checks the health of your Claude Code installation': 'Ê£ÄÊü•Claude CodeÂÆâË£ÖÂÅ•Â∫∑Áä∂ÊÄÅ',
                'Get usage help': 'Ëé∑Âèñ‰ΩøÁî®Â∏ÆÂä©',
                'Initialize project with CLAUDE.md guide': '‰ΩøÁî®CLAUDE.mdÊåáÂçóÂàùÂßãÂåñÈ°πÁõÆ',
                'Switch Anthropic accounts': 'ÂàáÊç¢AnthropicË¥¶Êà∑',
                'Sign out from your Anthropic account': 'ÈÄÄÂá∫AnthropicË¥¶Êà∑',
                'Manage MCP server connections and OAuth authentication': 'ÁÆ°ÁêÜMCPÊúçÂä°Âô®ËøûÊé•ÂíåOAuthËÆ§ËØÅ',
                'Edit CLAUDE.md memory files': 'ÁºñËæëCLAUDE.mdËÆ∞ÂøÜÊñá‰ª∂',
                'Select or change the AI model': 'ÈÄâÊã©ÊàñÊõ¥ÊîπAIÊ®°Âûã',
                'View or update permissions': 'Êü•ÁúãÊàñÊõ¥Êñ∞ÊùÉÈôê',
                'View pull request comments': 'Êü•ÁúãÊãâÂèñËØ∑Ê±ÇËØÑËÆ∫',
                'Request code review': 'ËØ∑Ê±Ç‰ª£Á†ÅÂÆ°Êü•',
                'View account and system statuses': 'Êü•ÁúãË¥¶Êà∑ÂíåÁ≥ªÁªüÁä∂ÊÄÅ',
                'Install Shift+Enter key binding for newlines': 'ÂÆâË£ÖShift+EnterÊç¢Ë°åÈîÆÁªëÂÆö',
                'Enter vim mode for alternating insert and command modes': 'ËøõÂÖ•vimÊ®°ÂºèÔºå‰∫§ÊõøÊèíÂÖ•ÂíåÂëΩ‰ª§Ê®°Âºè'
            };
            
            return translations[desc] || desc;
        }

        let selectedCommandIndex = -1;

        // ÁõëÂê¨input‰∫ã‰ª∂ÔºåËæÖÂä©Âà§Êñ≠ËæìÂÖ•Ê≥ïÁä∂ÊÄÅÂíåÂëΩ‰ª§Ë°•ÂÖ®
        function handleInput(event) {
            // ‰ΩøÁî® event.isComposing ‰Ωú‰∏∫È¢ùÂ§ñÁöÑÂà§Êñ≠‰æùÊçÆ
            if (event.isComposing !== undefined && event.isComposing !== isComposing) {
                console.log('üìù Input event Ê£ÄÊµãÂà∞ËæìÂÖ•Ê≥ïÁä∂ÊÄÅÂèòÂåñ:', event.isComposing);
                isComposing = event.isComposing;
            }

            // Â§ÑÁêÜÂëΩ‰ª§Ëá™Âä®Ë°•ÂÖ®
            const input = event.target;
            const value = input.value;
            const cursorPosition = input.selectionStart;
            
            // Ê£ÄÊü•ÂÖâÊ†á‰ΩçÁΩÆÁöÑÊñáÊú¨ÊòØÂê¶‰ª• / ÂºÄÂ§¥
            const textBeforeCursor = value.substring(0, cursorPosition);
            const lastSlashIndex = textBeforeCursor.lastIndexOf('/');
            
            if (lastSlashIndex !== -1 && lastSlashIndex === textBeforeCursor.length - 1) {
                // ÂàöËæìÂÖ• /ÔºåÊòæÁ§∫ÊâÄÊúâÂëΩ‰ª§
                showAutocomplete(claudeCommands, '');
            } else if (lastSlashIndex !== -1) {
                // Êúâ / ‰∏îÂêéÈù¢ÊúâÊñáÊú¨ÔºåËøõË°åÁ≠õÈÄâ
                const commandText = textBeforeCursor.substring(lastSlashIndex);
                if (commandText.startsWith('/') && commandText.length > 1) {
                    const query = commandText.toLowerCase();
                    const filteredCommands = claudeCommands.filter(cmd => 
                        cmd.command.toLowerCase().includes(query)
                    );
                    if (filteredCommands.length > 0) {
                        showAutocomplete(filteredCommands, query);
                    } else {
                        hideAutocomplete();
                    }
                } else if (commandText === '/') {
                    showAutocomplete(claudeCommands, '');
                }
            } else {
                hideAutocomplete();
            }
        }

        // ÊòæÁ§∫Ëá™Âä®Ë°•ÂÖ®‰∏ãÊãâÊ°Ü
        function showAutocomplete(commands, query) {
            const dropdown = document.getElementById('autocompleteDropdown');
            selectedCommandIndex = -1;
            
            dropdown.innerHTML = commands.map((cmd, index) => `
                <div class="autocomplete-item" data-index="${index}" onclick="selectCommand('${cmd.command}')">
                    <div class="autocomplete-command">${cmd.command}</div>
                    <div class="autocomplete-description">${cmd.description}</div>
                </div>
            `).join('');
            
            dropdown.classList.add('show');
        }

        // ÈöêËóèËá™Âä®Ë°•ÂÖ®‰∏ãÊãâÊ°Ü
        function hideAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.classList.remove('show');
            selectedCommandIndex = -1;
        }

        // ÈÄâÊã©ÂëΩ‰ª§
        function selectCommand(command) {
            const input = document.getElementById('messageInput');
            const value = input.value;
            const cursorPosition = input.selectionStart;
            
            // ÊâæÂà∞ÊúÄÂêé‰∏Ä‰∏™ / ÁöÑ‰ΩçÁΩÆ
            const textBeforeCursor = value.substring(0, cursorPosition);
            const lastSlashIndex = textBeforeCursor.lastIndexOf('/');
            
            if (lastSlashIndex !== -1) {
                // ÊõøÊç¢‰ªé / ÂºÄÂßãÂà∞ÂÖâÊ†á‰ΩçÁΩÆÁöÑÊñáÊú¨
                const newValue = value.substring(0, lastSlashIndex) + command + ' ' + value.substring(cursorPosition);
                input.value = newValue;
                
                // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆÂà∞ÂëΩ‰ª§ÂêéÈù¢
                const newCursorPos = lastSlashIndex + command.length + 1;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }
            
            hideAutocomplete();
            input.focus();
        }

        // Â§ÑÁêÜÈîÆÁõòÂØºËà™
        function handleAutocompleteNavigation(event) {
            const dropdown = document.getElementById('autocompleteDropdown');
            if (!dropdown.classList.contains('show')) return false;
            
            const items = dropdown.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return false;
            
            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedCommandIndex = (selectedCommandIndex + 1) % items.length;
                    updateSelectedCommand(items);
                    return true;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    selectedCommandIndex = selectedCommandIndex <= 0 ? items.length - 1 : selectedCommandIndex - 1;
                    updateSelectedCommand(items);
                    return true;
                    
                case 'Enter':
                    if (selectedCommandIndex >= 0 && selectedCommandIndex < items.length) {
                        event.preventDefault();
                        const selectedCommand = items[selectedCommandIndex].querySelector('.autocomplete-command').textContent;
                        selectCommand(selectedCommand);
                        return true;
                    }
                    break;
                    
                case 'Escape':
                    hideAutocomplete();
                    return true;
            }
            
            return false;
        }

        // Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑÂëΩ‰ª§Ê†∑Âºè
        function updateSelectedCommand(items) {
            items.forEach((item, index) => {
                if (index === selectedCommandIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Auto Resize Textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // Create New Session
        async function createNewSession() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/terminal/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        tool: 'claude', 
                        name: `claude-${Date.now()}` 
                    })
                });

                if (response.ok) {
                    const session = await response.json();
                    await loadSessions();
                    selectSession(session.id);
                }
            } catch (error) {
                console.error('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•:', error);
            }
        }

        // Clear Messages
        function clearMessages() {
            messages = [];
            hideTypingIndicator();
            renderMessages();
        }

        // Scroll to Bottom
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                // ‰ΩøÁî® requestAnimationFrame Á°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }

        // Âº∫Âà∂ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºàË∞ÉËØïÁî®Ôºâ
        function forceScrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
                console.log(`ÊªöÂä®: scrollHeight=${container.scrollHeight}, scrollTop=${container.scrollTop}`);
            }
        }
    </script>
</body>
</html>